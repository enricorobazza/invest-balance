{% extends '../main.html' %}
{% load static %}
{% block content %}

{% load guiabolso_tags %}

{% csrf_token %} 

<div class="row m-3">
  <div class="col-12">
    <div class="d-inline float-left">
      <ul class="nav nav-pills">
        <li class="nav-item border border-{% if not variable %}white{% else %}primary{% endif %} rounded">
          <a class="nav-link {% if not variable %}active{% endif %}" href="{% url 'list_guiabolso' %}">Todos</a>
        </li>
        <li class="nav-item border border-{% if variable %}white{% else %}primary{% endif %} rounded">
          <a class="nav-link {% if variable %}active{% endif %}" href="{% url 'list_guiabolso' %}?variable=true">Variáveis</a>
        </li>
      </ul>
    </div>
    <div class="d-inline float-left ml-3">
      <input type="text" id="startdate" class="datepicker" />
    </div>
    <div class="d-inline float-left ml-1">
      <input type="text" id="enddate" class="datepicker" />
    </div>
    <div id="filterCategory" class="d-inline float-left ml-1 pt-2">
      
    </div>
    <div class="d-inline float-right">
      {{last_updated|date:'d/m/Y'}} {{last_updated|time:'H:i'}}
      <a class="btn btn-secondary ml-2" href="{% url 'refresh_guiabolso' %}">
        <i class="fa fa-sync mr-1"></i>
        Atualizar
      </a>
    </div>
  </div>
</div>

<div class="row m-3">
  <div id="accordion" class="col-12">
    <div class="card">
      <div class="card-header" id="headingOne">
        <h5 class="mb-0">
          <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            Categorias
          </button>
        </h5>
      </div>
  
      <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
        <div class="card-body">
          <div class="table-responsive">
            <table id="categories" class="table my-2 table-striped">
              <thead class="thead-dark">
                <tr>
                  <th scope="col">Categoria</th>
                  <th scope="col">Valor (R$)</th>
                </tr>
              </thead>
              <tbody>
                {% if categories %}
                {% for category in categories %}
                <tr>
                  <td key="category_name" class="d-none">{{category.category__name}}</td>
                  <td key="category" class="align-middle">
                    <div style="
                      background-color:#{{category.category__color}};
                      color:#{{category.category__color|text_color}};
                      cursor: pointer;
                    " class="m-2 p-2 rounded d-inline">{{category.category__symbol|symbol}} {{category.category__name}}</div>
                  </td>
                  <td key="value" class="align-middle {% if category.value > 0 %} text-success {% else %} text-danger {% endif %}">{{category.value|stringformat:".2f"}}</td>
                </tr>

                {% endfor %}
                {% endif %}

                <tr class="bg-dark text-white">
                  <td class="align-middle pl-4">Total</td>
                  <td key="value" class="align-middle">{{total|stringformat:".2f"}}</td>
                </td>

              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header" id="headingTwo">
        <h5 class="mb-0">
          <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            Transações
          </button>
        </h5>
      </div>
      <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
        <div class="card-body">
          <div class="table-responsive">
            <table id="transactions" class="table my-2 table-striped">
              <thead class="thead-dark">
                <tr>
                  <th scope="col">Categoria</th>
                  <th scope="col">Data</th>
                  <th scope="col">Descrição</th>
                  <th scope="col">Valor (R$)</th>
                </tr>
              </thead>
              <tbody>
                {% if transactions %}
                {% for transaction in transactions %}
                <tr>
                  <td key="category_name" class="d-none">
                      {{transaction.category.name}}
                  </td>
                  <td key="category" class="align-middle">
                    <div style="
                      background-color:#{{transaction.category.color}};
                      color:#{{transaction.category.color|text_color}};
                    " class="m-2 p-2 rounded d-inline">{{transaction.category.symbol|symbol}} {{transaction.category.name}}</div>
                  </td>
                  <td key="date" class="align-middle">{{transaction.date|date:'d/m/Y'}}</td>
                  <td key="text" class="align-middle">{{transaction.text}}</td>
                  <td key="value" class="align-middle {% if transaction.value > 0 %} text-success {% else %} text-danger {% endif %}">{{transaction.value}}</td>
                </tr>

                {% endfor %}
                {% endif %}

              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const updateUrl = (newParam) => {
    const urlSearchParams = new URLSearchParams(window.location.search);
    let params = Object.fromEntries(urlSearchParams.entries());
    params = {...params, ...newParam};

    let url = "{% url 'list_guiabolso' %}?";

    Object.keys(params).forEach(key => {
      url += `${key}=${params[key]}&`
    });

    url = url.substr(0, url.length-1);

    window.location.href = url;
  }

  $(document).ready(() => {
    $("#startdate").datepicker({
      uiLibrary: 'bootstrap4',

      {% if startdate %}
        value: "{{startdate|date:'d/m/Y'}}",
      {% else %}
        value: moment(new Date()).tz('America/Sao_paulo').format("DD/MM/YYYY"),
      {% endif %}
      
      locale: 'pt-br',
      format: 'dd/mm/yyyy'
    });

    $("#enddate").datepicker({
      uiLibrary: 'bootstrap4',

      {% if enddate %}
        value: "{{enddate|date:'d/m/Y'}}",
      {% else %}
        value: moment(new Date()).tz('America/Sao_paulo').format("DD/MM/YYYY"),
      {% endif %}

      locale: 'pt-br',
      format: 'dd/mm/yyyy'
    });

    let enddate = $("#enddate").val();
    let startdate = $("#startdate").val();

    $("#startdate").change(e => {
      e.preventDefault();
      if(startdate !== e.target.value) {
        updateUrl({"startdate": e.target.value});
      }
    })

    $("#enddate").change(e => {
      e.preventDefault();
      if(enddate !== e.target.value) {
        updateUrl({"enddate": e.target.value});
      }
    })

    const filterTransactions = (category = "") => {
      $("#transactions tbody tr").hide();
      $("#transactions tbody tr").each((i, transaction) => {
          const _category = $(transaction).find("td[key='category_name']").first().html().trim()
          if(category == "" || _category == category)
            $(transaction).show() 
      })
    } 

    $("#categories td[key='category']").click(e => {
      const category = $(e.target).parent().parent().find("td[key='category_name']").first().html().trim()
      const div = $("<div />");
      div.html($(e.target).parent().html());
      div.find("div").first().append("<i class='ml-2 fa fa-times'></i>")
      $("#filterCategory").html(div.html());
      filterTransactions(category)
      $("#filterCategory").click(e => {
        $("#filterCategory").html("");
        filterTransactions()
        $("#collapseOne").collapse('show');
      })
      $("#collapseTwo").collapse('show');
    })
  });
</script>

{% endblock %}